<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FusionTalk üî•</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    #sidebar {
      width: 250px;
      background: #eee;
      overflow-y: auto;
      padding: 10px;
      transition: background 0.3s;
    }
    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      transition: background 0.3s;
      position: relative;
    }
    #chatWith {
      background: #ddd;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      animation: fadeIn 1s ease forwards;
    }
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #f5f5f5;
      animation: fadeIn 1s ease forwards;
    }
    #inputArea {
      display: flex;
      padding: 10px;
      background: #ddd;
      transition: background 0.3s;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: none;
      outline: none;
      font-size: 16px;
    }
    #sendBtn {
      margin-left: 10px;
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      background: #4caf50;
      color: white;
      cursor: pointer;
      transition: transform 0.2s;
    }
    #sendBtn:hover {
      transform: scale(1.05);
    }
    .user {
      padding: 8px;
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
    }
    .user:hover {
      background: #ccc;
    }
    .unread {
      background: #ffd700;
    }
    .message {
      max-width: 70%;
      margin: 5px;
      padding: 10px 15px;
      border-radius: 20px;
      clear: both;
      word-wrap: break-word;
      animation: messageAppear 0.3s ease forwards;
    }
    .message.you {
      background: #dcf8c6;
      float: right;
    }
    .message.other {
      background: #fff;
      float: left;
    }
    @keyframes messageAppear {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }
    #themeToggle {
      text-align: center;
      padding: 10px;
      background: #ddd;
      cursor: pointer;
      transition: background 0.3s;
    }
    /* Dark/Light mode styles */
    body.light-mode {
      background: #f5f5f5;
      color: #333;
    }
    body.dark-mode {
      background: #121212;
      color: #f5f5f5;
    }
    #sidebar.light-mode {
      background: #eee;
    }
    #sidebar.dark-mode {
      background: #1e1e1e;
    }
    #chat.light-mode {
      background: #fff;
    }
    #chat.dark-mode {
      background: #2c2c2c;
    }
    #inputArea.light-mode {
      background: #ddd;
    }
    #inputArea.dark-mode {
      background: #444;
    }
    #themeToggle.light-mode {
      background: #ddd;
      color: #333;
    }
    #themeToggle.dark-mode {
      background: #333;
      color: #f5f5f5;
    }
    .message.you.light-mode {
      background: #dcf8c6;
      color: #000;
    }
    .message.you.dark-mode {
      background: #4caf50;
      color: #fff;
    }
    .message.other.light-mode {
      background: #fff;
      color: #000;
    }
    .message.other.dark-mode {
      background: #333;
      color: #fff;
    }
    /* File and Poll area styles */
    #extraOptions {
      display: flex;
      justify-content: space-around;
      padding: 10px;
      background: #eee;
    }
    #extraOptions.light-mode {
      background: #eee;
    }
    #extraOptions.dark-mode {
      background: #444;
    }
    .extra-btn {
      padding: 8px 12px;
      border-radius: 8px;
      background: #2196f3;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s;
    }
    .extra-btn:hover {
      transform: scale(1.05);
    }
    /* Animation fadeIn */
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }
    /* Stars animation container */
    .stars {
      position: absolute;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }
    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: twinkle 2s infinite;
    }
    @keyframes twinkle {
      0%, 100% {opacity: 0;}
      50% {opacity: 1;}
    }
    :root {
  --card-bg: #ffffff;
  --text: #111;
}
body.dark-mode { --card-bg: #222; --text:#eee; }

  </style>
</head>
<body>
  <!-- Poll Modal -->
<div id="pollModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:9999;">
  <div style="background:var(--card-bg,#fff); color:var(--text,#000); padding:20px; border-radius:12px; width:90%; max-width:420px;">
    <h3>Create Poll</h3>
    <input id="pollQuestion" placeholder="Poll question" style="width:100%; padding:8px; margin:8px 0; border-radius:8px" />
    <input id="pollOptions" placeholder="Options (comma separated)" style="width:100%; padding:8px; margin:8px 0; border-radius:8px" />
    <div style="display:flex; gap:8px; justify-content:flex-end;">
      <button onclick="closePollModal()" style="padding:8px 12px;border-radius:8px;">Cancel</button>
      <button onclick="createPoll()" style="padding:8px 12px;border-radius:8px;background:#2196f3;color:#fff;">Create</button>
    </div>
  </div>
</div>

<!-- Hidden file inputs (if not already present) -->
<input type="file" id="fileInput" style="display:none" />
<input type="file" id="photoInput" accept="image/*" style="display:none" />

<!-- Upload progress bar (simple) -->
<div id="uploadProgress" style="position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background: rgba(0,0,0,0.7); color:#fff; padding:8px 12px; border-radius:12px; display:none; z-index:9999;">
  <div id="uploadText">Uploading...</div>
  <div style="height:6px; background:#222; border-radius:6px; margin-top:6px; overflow:hidden;">
    <div id="uploadBar" style="width:0%; height:100%; background:#4caf50;"></div>
  </div>
</div>

<!-- Drag & Drop hint inside extraOptions or near messages -->
<div id="dropZone" style="position: absolute; right: 20px; bottom: 100px; padding:8px 12px; border-radius:8px; background: rgba(255,255,255,0.06); color:inherit; display:none; z-index:500;">
  Drop file to upload
</div>

  <div id="sidebar" class="light-mode">
    <h3>Users</h3>
    <div id="users"></div>
  </div>
  <div id="chat" class="light-mode">
    <div id="chatWith">FusionTalk Chat</div>
    <div id="messages"></div>
    <div id="extraOptions" class="light-mode">
      <div class="extra-btn" onclick="uploadFile()">üìÅ Upload File</div>
      <div class="extra-btn" onclick="uploadPhoto()">üì∏ Upload Photo</div>
      <div class="extra-btn" onclick="createPoll()">üìä Create Poll</div>
    </div>
    <div id="inputArea" class="light-mode">
      <input id="messageInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>
  <div id="themeToggle" class="light-mode" onclick="toggleTheme()">üåô</div>
  <div class="stars" id="stars"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const messagesDiv = document.getElementById('messages');
    const usersDiv = document.getElementById('users');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    const chatWithDiv = document.getElementById('chatWith');
    const themeToggle = document.getElementById('themeToggle');
    const starsContainer = document.getElementById('stars');
    const sidebar = document.getElementById('sidebar');
    const chat = document.getElementById('chat');
    const inputArea = document.getElementById('inputArea');
    const extraOptions = document.getElementById('extraOptions');

    // Add twinkling stars animation
    for(let i = 0; i < 50; i++){
      const star = document.createElement('div');
      star.classList.add('star');
      star.style.top = Math.random() * 100 + '%';
      star.style.left = Math.random() * 100 + '%';
      star.style.animationDuration = 1 + Math.random() * 2 + 's';
      starsContainer.appendChild(star);
    }

    const username = localStorage.getItem('username');
    if (!username) {
      window.location.href = 'index.html';
    }
    socket.emit('join', username);

    let selectedUser = null;
    let userElements = {};

    socket.on('userList', (users) => {
      usersDiv.innerHTML = "";
      userElements = {};
      users.forEach(user => {
        const div = document.createElement('div');
        div.classList.add('user');
        div.innerHTML = `${user.emoji} ${user.name}`;
        div.addEventListener('click', () => {
          selectedUser = user.name === username ? null : user;
          chatWithDiv.textContent = selectedUser ? `Chat with: ${user.name}` : "FusionTalk Chat";
          div.classList.remove('unread');
        });
        usersDiv.appendChild(div);
        userElements[user.id] = div;
      });
    });

    socket.on('chatMessage', (data) => {
      const div = document.createElement('div');
      div.classList.add('message');
      if(data.name === username){
        div.classList.add('you');
        div.innerHTML = `<div>You: ${data.msg}</div>`;
      } else {
        div.classList.add('other');
        div.innerHTML = `<div>${data.emoji} ${data.name}: ${data.msg}</div>`;
        if(data.private && (!selectedUser || selectedUser.id !== data.id)){
          if(userElements[data.id]){
            userElements[data.id].classList.add('unread');
          }
        }
      }
      applyThemeToMessage(div);
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    sendBtn.addEventListener('click', () => {
      const msg = messageInput.value.trim();
      if(msg){
        if(selectedUser){
          socket.emit('privateMessage', { targetId: selectedUser.id, msg: msg });
          addMessage("You: " + msg, 'you');
        } else {
          socket.emit('message', msg);
          addMessage("You: " + msg, 'you');
        }
        messageInput.value = '';
      }
    });

    function addMessage(text, type) {
      const div = document.createElement('div');
      div.classList.add('message', type);
      div.innerHTML = `<div>${text}</div>`;
      applyThemeToMessage(div);
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function applyThemeToMessage(div){
      const theme = document.body.classList.contains('dark-mode') ? 'dark-mode' : 'light-mode';
      div.classList.add(theme);
    }

    function toggleTheme() {
      if(document.body.classList.contains('dark-mode')){
        document.body.classList.replace('dark-mode','light-mode');
        sidebar.classList.replace('dark-mode','light-mode');
        chat.classList.replace('dark-mode','light-mode');
        inputArea.classList.replace('dark-mode','light-mode');
        extraOptions.classList.replace('dark-mode','light-mode');
        themeToggle.classList.replace('dark-mode','light-mode');
        themeToggle.textContent = 'üåô';
      } else {
        document.body.classList.replace('light-mode','dark-mode');
        sidebar.classList.replace('light-mode','dark-mode');
        chat.classList.replace('light-mode','dark-mode');
        inputArea.classList.replace('light-mode','dark-mode');
        extraOptions.classList.replace('light-mode','dark-mode');
        themeToggle.classList.replace('light-mode','dark-mode');
        themeToggle.textContent = '‚òÄÔ∏è';
      }
    }

    function uploadFile() {
      alert("File upload functionality coming soon!");
    }
    function uploadPhoto() {
      alert("Photo upload functionality coming soon!");
    }
    function createPoll() {
      alert("Poll creation functionality coming soon!");
    }
function openPollModal(){
  document.getElementById('pollModal').style.display = 'flex';
}
function closePollModal(){
  document.getElementById('pollModal').style.display = 'none';
}

async function createPoll(){
  const q = document.getElementById('pollQuestion').value.trim();
  const optsRaw = document.getElementById('pollOptions').value.trim();
  if(!q || !optsRaw){
    alert('Enter question and options (comma separated)');
    return;
  }
  const opts = optsRaw.split(',').map(o => o.trim()).filter(Boolean);
  if(opts.length < 2){
    alert('Please give at least 2 options.');
    return;
  }

  // send to server
  try {
    const resp = await fetch('/poll', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ question: q, options: opts })
    });
    if(!resp.ok) throw new Error('Failed to create poll');
    const poll = await resp.json();

    // broadcast via socket so other clients show instantly
    socket.emit('pollCreated', poll);

    // locally display poll
    showPoll(poll);
    closePollModal();
    document.getElementById('pollQuestion').value = '';
    document.getElementById('pollOptions').value = '';
  } catch(err) {
    console.error(err);
    alert('Could not create poll');
  }
}

// Show poll in UI (append to messages)
function showPoll(poll) {
  // poll: { id, question, options, votes }
  const div = document.createElement('div');
  div.classList.add('message', 'other'); // style as incoming
  const optionsHtml = poll.options.map((opt, idx) => {
    return `<div style="margin:6px 0; display:flex; justify-content:space-between; align-items:center;">
      <div>${opt}</div>
      <div><button style="padding:6px 10px;border-radius:8px;" onclick="votePoll(${poll.id}, ${idx}, this)">Vote</button></div>
    </div>`;
  }).join('');
  div.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${poll.question}</div>
    <div>${optionsHtml}</div>
    <div id="poll-${poll.id}-results" style="margin-top:8px;font-size:13px;color:gray;"></div>`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// handle votes - emit to server via socket for simplicity
function votePoll(pollId, optionIndex, btnEl) {
  socket.emit('votePoll', { pollId, optionIndex });
  btnEl.disabled = true;
  btnEl.textContent = 'Voted';
}

// Listen for poll events from server
socket.on('pollCreated', (poll) => {
  showPoll(poll);
});

// Server will emit updated poll data after votes; listen and update UI
socket.on('pollUpdated', (poll) => {
  const resDiv = document.getElementById(`poll-${poll.id}-results`);
  if(!resDiv) return;
  const total = poll.votes.reduce((a,b)=>a+b,0) || 1;
  const html = poll.options.map((opt, idx) => {
    const pct = Math.round((poll.votes[idx] / total) * 100);
    return `<div style="display:flex; justify-content:space-between;"><div>${opt}</div><div>${poll.votes[idx]} (${pct}%)</div></div>`;
  }).join('');
  resDiv.innerHTML = html;
});

const fileInputEl = document.getElementById('fileInput');
const photoInputEl = document.getElementById('photoInput');
const uploadProgressEl = document.getElementById('uploadProgress');
const uploadBar = document.getElementById('uploadBar');
const uploadText = document.getElementById('uploadText');
const dropZone = document.getElementById('dropZone');

function uploadFile(){
  fileInputEl.click();
}
function uploadPhoto(){
  photoInputEl.click();
}

fileInputEl.addEventListener('change', (e) => {
  const f = e.target.files[0];
  if(f) doUploadWithProgress(f);
  e.target.value = '';
});
photoInputEl.addEventListener('change', (e) => {
  const f = e.target.files[0];
  if(f) {
    if(!f.type.startsWith('image/')) { alert('Select an image'); return; }
    doUploadWithProgress(f);
  }
  e.target.value = '';
});

async function doUploadWithProgress(file){
  // show progress UI
  uploadProgressEl.style.display = 'block';
  uploadText.textContent = `Uploading ${file.name}...`;
  uploadBar.style.width = '0%';

  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/upload');
    xhr.upload.onprogress = (ev) => {
      if(ev.lengthComputable){
        const pct = Math.round((ev.loaded / ev.total) * 100);
        uploadBar.style.width = pct + '%';
      }
    };
    xhr.onload = () => {
      uploadProgressEl.style.display = 'none';
      if(xhr.status >= 200 && xhr.status < 300){
        const data = JSON.parse(xhr.responseText);
        // notify server via socket
        socket.emit('fileShared', { url: data.url, originalName: data.originalName });
        // show immediately
        displayFileMessage({ id: socket.id, name: username, originalName: data.originalName, url: data.url });
        resolve(data);
      } else {
        alert('Upload failed');
        reject(new Error('upload failed'));
      }
    };
    xhr.onerror = () => {
      uploadProgressEl.style.display = 'none';
      alert('Upload error');
      reject(new Error('upload error'));
    };
    const fd = new FormData();
    fd.append('file', file);
    xhr.send(fd);
  });
}

// Drag & drop handlers on the document
document.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.style.display = 'block';
});
document.addEventListener('dragleave', (e) => {
  // if leaving window, hide
  if(e.clientX === 0 && e.clientY === 0) dropZone.style.display = 'none';
});
document.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.style.display = 'none';
  const file = e.dataTransfer.files && e.dataTransfer.files[0];
  if(file) doUploadWithProgress(file);
});
</script>
</body>
</html>
